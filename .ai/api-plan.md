# REST API Plan

## 1. Resources

The API will expose the following main resources, each corresponding to a table or business concept in the application:

- **Users**: Represents the registered users of the application. Maps to the `users` table.
- **Flashcards**: Represents flashcards created either manually or generated by the AI. Maps to the `flashcards` table.
- **Generations**: Records metadata and statistics about AI-based flashcard generation sessions. Maps to the `generations` table.
- **Generation Error Logs**: Stores error logs related to flashcard generation. Maps to the `generation_error_logs` table.

## 2. Endpoints

For each resource, the API will support standard CRUD operations as well as business-specific actions. Endpoints will follow RESTful conventions and include pagination, filtering, and sorting for list endpoints.

### 2.2. Flashcard Endpoints

1. **List Flashcards**

   - **Method:** GET
   - **URL:** `/api/flashcards`
   - **Description:** Retrieve a paginated list of flashcards for the authenticated user.
   - **Query Parameters:**
     - `page` (optional, default = 1)
     - `limit` (optional, default = 10)
     - `sort_by` (optional, e.g., `created_at`)
     - `order` (optional, `asc` or `desc`)
   - **Response Payload (JSON):**
     ```json
     {
       "data": [
         {
           "id": "uuid",
           "front": "string",
           "back": "string",
           "source": "AI-full | AI-edited | manual",
           "generation_id": "uuid or null",
           "created_at": "ISO8601 timestamp",
           "updated_at": "ISO8601 timestamp"
         }
       ],
       "pagination": {
         "page": 1,
         "limit": 10,
         "total": 100
       }
     }
     ```
   - **Success Codes:** 200 OK
   - **Error Codes:** 401 Unauthorized

2. **Get a Single Flashcard**

   - **Method:** GET
   - **URL:** `/api/flashcards/{id}`
   - **Description:** Get details for a specific flashcard.
   - **Response Payload (JSON):** Similar to individual flashcard data as above.
   - **Success Codes:** 200 OK
   - **Error Codes:** 401 Unauthorized, 404 Not Found

3. **Create Flashcards**

   - **Method:** POST
   - **URL:** `/api/flashcards`
   - **Description:** Create one or multiple flashcards, supporting both manual creation and AI-generated cards.
   - **Request Payload (JSON):**
     ```json
     {
       "flashcards": [
         {
           "front": "Question text",
           "back": "Answer text",
           "source": "manual | AI-full | AI-edited",
           "generation_id": "uuid or null"
         }
       ]
     }
     ```
   - **Response Payload (JSON):**
     ```json
     {
       "data": [
         {
           "id": "uuid",
           "front": "Question text - maximium length: 200 characters",
           "back": "Answer text - maximum lenght 500 characters",
           "source": "manual | AI-full | AI-edited",
           "generation_id": "uuid or null - required for 'AI-full' and 'AI-edited' sources, must be NULL for 'manual' source",
           "created_at": "ISO8601 timestamp",
           "updated_at": "ISO8601 timestamp"
         }
       ],
       "failed": [
         {
           "index": 0,
           "error": "Error message"
         }
       ]
     }
     ```
   - **Success Codes:** 201 Created
   - **Error Codes:** 400 Bad Request, 401 Unauthorized

4. **Update a Flashcard (Approval or Edit)**

   - **Method:** PUT
   - **URL:** `/api/flashcards/{id}`
   - **Description:** Update flashcard details (used for both editing manual flashcards and approving AI-generated suggestions).
   - **Request Payload (JSON):**
     ```json
     {
       "front": "Updated question - max lenght 200 characters",
       "back": "Updated answer - max lenght 500 characters",
       "source": "AI-edited - must be one of 'AI-edited' or 'manual'"
     }
     ```
   - **Success Codes:** 200 OK
   - **Error Codes:** 400 Bad Request, 401 Unauthorized, 404 Not Found

5. **Delete a Flashcard**
   - **Method:** DELETE
   - **URL:** `/api/flashcards/{id}`
   - **Description:** Remove a flashcard permanently.
   - **Success Codes:** 204 No Content
   - **Error Codes:** 401 Unauthorized, 404 Not Found

---

### 2.3. AI-based Flashcard Generation Endpoints

1. **Generate Flashcards from Text**

   - **Method:** POST
   - **URL:** `/api/flashcards/generate`
   - **Description:** Accepts a block of text (between 1,000 and 10,000 characters) and triggers the LLM to generate flashcard suggestions.
   - **Request Payload (JSON):**
     ```json
     {
       "source_text": "A long text input with at least 1000 characters..."
     }
     ```
   - **Response Payload (JSON):**
     ```json
     {
       "generation_id": "uuid",
       "model": "model identifier",
       "suggestions": [
         {
           "front": "Generated question",
           "back": "Generated answer",
           "source": "AI-full"
         }
       ],
       "generated_count": 5
     }
     ```
   - **Business Logic:**
     - Validate that the `source_text` length is within the allowed range (1000 to 10000 characters).
     - Create a new record in the `generations` table.
     - Generate flashcard suggestions and do not persist them until approved.
   - **Success Codes:** 200 OK, 201 Created
   - **Error Codes:** 400 Bad Request, 401 Unauthorized, 422 Unprocessable Entity (if text length invalid)

2. **Approve or Reject Generated Flashcards**
   - **Method:** PUT
   - **URL:** `/api/flashcards/{id}` (same as update endpoint)
   - **Description:** Endpoint used by the client to approve (and optionally edit) an AI-generated flashcard.
   - **Note:** The client may modify the flashcard data before approval, which updates the `source` field to indicate an edited state if applicable.

---

### 2.4. Generation Endpoints

1. **List Generation Sessions**

   - **Method:** GET
   - **URL:** `/api/generations`
   - **Description:** List all generation sessions for the authenticated user with pagination.
   - **Response Payload (JSON):**
     ```json
     {
       "data": [
         {
           "id": "uuid",
           "model": "model identifier",
           "generated_count": 10,
           "accepted_unedited_count": 5,
           "accepted_edited_count": 2,
           "created_at": "ISO8601 timestamp"
         }
       ],
       "pagination": { "page": 1, "limit": 10, "total": 50 }
     }
     ```
   - **Success Codes:** 200 OK
   - **Error Codes:** 401 Unauthorized

2. **Get Details of a Generation Session**
   - **Method:** GET
   - **URL:** `/api/generations/{id}`
   - **Description:** Retrieve detailed information about a specific generation session.
   - **Success Codes:** 200 OK
   - **Error Codes:** 401 Unauthorized, 404 Not Found

---

### 2.5. Generation Error Logs Endpoints

1. **List Generation Error Logs**
   - **Method:** GET
   - **URL:** `/api/generation-error-logs`
   - **Description:** Retrieve error logs associated with flashcard generation sessions for the authenticated user.
   - **Response Payload (JSON):**
     ```json
     {
       "data": [
         {
           "id": "uuid",
           "model": "model identifier",
           "error_code": "ERROR_CODE",
           "error_message": "Description of the error",
           "created_at": "ISO8601 timestamp"
         }
       ]
     }
     ```
   - **Success Codes:** 200 OK
   - **Error Codes:** 401 Unauthorized

---

## 3. Authentication and Authorization

- The API will use JWT-based authentication. Upon successful login, a JWT is issued and must be included in the `Authorization` header (Bearer token) for subsequent requests.
- The backend, powered by Supabase, will enforce Row Level Security (RLS) on all database operations ensuring users can only access their own data.
- Endpoints will return 401 Unauthorized if the request is made without valid credentials.

## 4. Validation and Business Logic

- **Flashcard Validation:**
  - The `source` field in flashcards must be one of `AI-full`, `AI-edited`, or `manual`.
- **Generation Validation:**
  - The provided `source_text` length must be between 1000 and 10000 characters before initiating AI processing.
- **Business Logic:**
  - In the AI-based flashcard generation endpoint, the generation process creates a temporary set of suggestions that must later be either approved or rejected by the user via the update flashcard endpoint.
  - Proper error handling for LLM API failures is implemented and logged in the `generation_error_logs` table.

## 5. Additional Considerations

- **Pagination, Filtering, and Sorting:**
  - List endpoints support query parameters for pagination (`page`, `limit`), sorting (`sort_by`, `order`), and filtering based on common fields (e.g., `created_at`).
- **Rate Limiting:**
  - To prevent abuse, particularly on the flashcard generation endpoint, rate limiting measures should be implemented (e.g., X requests per minute).
- **Error Responses:**
  - The API will return consistent JSON error messages including error codes and descriptive messages for ease of debugging and improved client UX.
- **Security:**
  - The API will enforce HTTPS in production, validate all inputs rigorously, and include logging to monitor abuse or errors.

This comprehensive plan maps the database schema and product requirements directly to RESTful endpoints and establishes a robust foundation for implementing our API in accordance with the specified tech stack (Astro, React, TypeScript, Supabase, and Tailwind).
